<!DOCTYPE doctype PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type"
 content="text/html; charset=iso-8859-1">
  <title>Program 9, CSci 39542: Data Science, Hunter College</title>
</head>
<STYLE>A {text-decoration: none;}
th, td { padding: 5px; }
code {
  background-color: #eeeeee;
}
.inline {
  padding: 1px;
}
.blockcode {
  border: 1px solid #999999;
  display: block;
  padding-left: 10px;
  padding-top : 2px;
  padding-bottom : 2px;
  margin: 5px;
}
.datablock {
  border: 1px solid #eeeeee;
  display: block;
  padding: 7px;
  padding-top : 0px;
  margin: 5px;
}
</STYLE>
<body>


<div style="margin: 15px;width=100%;">
    <span style= "float: left;font-size:larger"><a href="index.html">CSci 39542</a></span>
    <span style= "float: right">
      <a href="syl.html">Syllabus</a>&nbsp;&nbsp;&nbsp;
      <a href="resources.html">Resources</a>&nbsp;&nbsp;&nbsp;
      <a href="work.html">Coursework</a><!--&nbsp;&nbsp;&nbsp;
      <a href="faq.html">FAQ</a>-->
    </span>
</div>

<br>
<br>
<hr>

<div style="margin:50px">


<h2>Program 9:  Logistic Taxi
  <br>CSci 39542: Introduction to Data Science<br>
<a href="http://www.hunter.cuny.edu/csci">Department of Computer Science</a><br>
<a href="https://hunter.cuny.edu">Hunter College</a>, <a href="https://www.cuny.edu">City University of New York</a><br>
Spring 2022<br><br>
</h2>


<hr>
<a href="work.html#cw">Classwork</a>&nbsp;&nbsp;&nbsp;
<a href="work.html#quizzes">Quizzes</a>&nbsp;&nbsp;&nbsp;
<a href="work.html#hw">Homework</a>&nbsp;&nbsp;&nbsp;
<a href="work.html#project">Project</a>&nbsp;&nbsp;&nbsp;
<hr>


<object width=100% height=50% type="text/html" data="generalNotes.html" border="0"
   style="overflow: hidden;">
</object>

<hr>

<h2>Program Description</h2>

<br>
   <p><a name="p9"><b>Program 9: Logistic Taxis.</b></b> &emsp; <i>Due noon, Thursday, 7 April.
     <br>Learning Objective:  to train and validate models, given quantitative and qualitative data, as well as assessing model quality.
     <br>Available Libraries: pandas, datetime, pickle, sklearn, and core Python 3.6+.
     (Note if you use our annonations, you should from typing import Union.)
     <br>Data Sources: <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> and <a href="https://data.cityofnewyork.us/Transportation/NYC-Taxi-Zones/d3c5-ddgc">NYC Taxi Zones</a> from OpenData NYC.
     <br>Sample Datasets:  <a href="../fall21/taxi_new_years_day_2020.csv">taxi_new_years_day_2020.csv</a>,
      <a href="../fall21/taxi_new_years_day_2020.csv">taxi_4July2020.csv</a>,
      <a href="taxi_jfk_june2020.csv">taxi_jfk_june2020.csv</a>, and
      <a href="taxi_zones.csv">taxi_zones.csv</a>.<br></i>

<br>
<p>
<a href="https://www1.nyc.gov/site/tlc/businesses/yellow-cab.page"><img src = "https://www1.nyc.gov/assets/tlc/images/content/pages/businesses/yellow-cab.png" height=300 alt="image of yellow taxi"></a>

<p>
As in  <a href="p8.html">Program 8</a>, this program is tailored to the NYC OpenData Yellow Taxi Trip Data and follows standard strategy for data cleaning and model building:
    <ol>
       <li> Read in datasets, merging and cleaning as needed.
       <li> Impute missing values (we will use median for the ordinal values and "most popular" for nominal values).
       <li> Use categorical encoding for qualitative values.
       <li> Split our dataset into training and testing sets.
       <li> Fit a model, or multiple models, to the training dataset.
       <li> Validate the models using the testing dataset.
    </ol>
To identify which trips are most likely to cross between boroughs, this program will focus on building a logistic regression model on both the categorical and numerical features of our dataset.
The function specifications are below:

<p>In your program, include the following functions from <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard:
<ul>
    <li> <code class = "inline">import_data(file_name) -> pd.DataFrame:</code>
      This function takes as one input parameter:
      <ul>
        <li> <code class = "inline">file_name</code>: the name of a CSV file containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC.
      </ul>
      The data in the file is read into a DataFrame, and the resulting DataFrame is returned.  <br>(Note this is identical to the function with the same name in <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard.)
      <br>
    <li> <code class = "inline">add_tip_time_features(df) -> pd.DataFrame:</code>
      This function takes one input:
      <ul>
        <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC.
      </ul>
      The function computes 3 new columns:
      <ul>
        <li><code class = "inline">percent_tip</code>: which is <code class="inline">100*tip_amount/(total_amount-tip_amount)</code>
        <li><code class = "inline">duration</code>: the time the trip took in seconds.
        <li><code class = "inline">dayofweek</code>: the day of the week that the trip started, represented as 0 for Monday, 1 for Tuesday, ... 6 for Sunday.
      </ul>
      The original DataFrame with these additional three columns is returned.
      <br> (Note this is identical to the function with the same name in <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard.)
      <br>
      <li> <code class = "inline">impute_numeric_cols(df, x_num_cols) -> pd.DataFrame:</code>
        This function takes two inputs:
        <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing Yellow Taxi Trip Data from OpenData NYC.
          <li> <code class = "inline">x_num_cols</code>: a list of numerical columns in <code class = "inline">df</code>.
        </ul>
        Missing data in the columns <code class = "inline">x_num_cols</code> are replaced with the median of the column.  Returns a DataFrame containing only the imputed numerical columns from input <code class = "inline">df</code>.
    <br>(Note this is identical to the function with the same name in <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard.)
  </ul>

And write the following new functions:

  <ul>
    <li> <code class = "inline">add_boro(df, file_name) -> pd.DataFrame:</code>
      This function takes as two input parameters:
      <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC.
          <li> <code class = "inline">file_name</code>: the name of a CSV file containing <a href="https://data.cityofnewyork.us/Transportation/NYC-Taxi-Zones/d3c5-ddgc">NYC Taxi Zones</a> from OpenData NYC.
      </ul>
      Makes a DataFrame, using <code class = "inline">file_name</code>, to add pick up and drop off boroughs to <code class = "inline">df</code>.
      In particular, adds two new columns to the <code class = "inline">df</code>:
      <ul>
        <li> <code class = "inline">PU_borough</code> that contain the borough corresponding to the pick up taxi zone ID (stored in <code class = "inline">PULocationID</code>), and
        <li> <code class = "inline">DO_borough</code> that contain the borough corresponding to the drop off taxi zone (stored in <code class = "inline">DOLocationID</code>)
      </ul>
      Returns <code class = "inline">df</code> with these two additional columns (<code class = "inline">PU_borough</code> and <code class = "inline">DO_borough</code>).

    <li> <code class = "inline">add_flags(df) -> pd.DataFrame:</code>
      This function takes one input parameter:
      <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC to which <code class = "inline">add_boro()</code> has been applied.
      </ul>
      Adds two new columns:
      <ul>
        <li> <code class = "inline">paid_toll</code> which is 1 if a toll was paid on the trip and 0 in no tolls were paid.
        <li> <code class = "inline">cross_boro</code> which is 1 if the trip started and ended in different borough, and 0 if the trip started and ended in the same borough.
      </ul>
      Returns <code class = "inline">df</code> with these two additional columns (<code class = "inline">paid_toll</code> and <code class = "inline">cross_boro</code>).
      <br>

    <li> <code class = "inline">encode_categorical_col(col,prefix) -> pd.DataFrame:</code>
      This function takes two input parameters:
      <ul>
          <li> <code class = "inline">col</code>: a column of categorical data.
          <li> <code class = "inline">prefix</code>: a prefix to use for the labels of the resulting columns.
      </ul>
      Takes a column of categorical data and uses categorical encoding to create a new DataFrame with the k-1 columns, where k is the number of different nomial values for the column.  Your function should create k columns, one for each value, labels by the prefix concatenated with the value.  The columns should be sorted and the DataFrame restricted to the first k-1 columns returned.  For example, if the column contains values:  'Bronx', 'Brooklyn', 'Manhattan', 'Queens', and 'Staten Island', and the  <code class = "inline">prefix</code> parameter has the value 'PU_', then the resulting columns would be labeled: 'PU_Bronx', 'PU_Brooklyn', 'PU_Manhattan', 'PU_Queens', and 'PU_Staten Island'.  The last one alphabetically is dropped (in this example, 'PU_Staten Island') and the DataFrame restricted to the first k-1 columns is returned.  Note:  we presented several different ways to categorically encode nomial data in Lecture 14.  The book details an approach using sklearn in <a href="http://www.textbook.ds100.org/ch/20/feature_one_hot.html">Chapter 20</a>,
      and you may find <a href="https://pandas.pydata.org/docs/reference/api/pandas.get_dummies.html#pandas.get_dummies">Panda's get_dummies</a> useful.
      <br>

    <li> <code class = "inline">split_test_train(df, xes_col_names, y_col_name,
                       test_size=0.25, random_state=12345) -> Union[pd.DataFrame, pd.Series()]:</code>
      This function takes 5 input parameters:
       <ul>
           <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC to which <code class = "inline">add_boro()</code> has been applied.
           <li>  <code class = "inline">y_col_name</code>: the name of the column of the dependent variable.
           <li>  <code class = "inline">xes_col_names</code>: a list of columns that contain the independent variables.
           <li>  <code class = "inline">test_size</code>: accepts a float between 0 and 1 and represents the proportion of the data set to use for training.  This parameter has a default value of 0.25.
           <li>  <code class = "inline">random_state</code>:  Used as a seed to the randomization.  This parameter has a default value of 12345.
      </ul>
      Calls <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html">sklearn's train_test_split</a> function to split the data set into a training and testing subsets:  x_train, x_test, y_train, y_test.  The resulting 4 subsets are returned.<br>
      Hint:  see the examples for <a href="p8.html">Program 8</a> for a similar splitting of data into training and testing datasets.

    <li> <code class = "inline">fit_logistic_regression(x_train, y_train,penalty='none'): -> object</code>
      This function takes three input parameter:
      <ul>
          <li> <code class = "inline">x_train</code>: the indepenent variable(s) for the analysis.
          <li> <code class = "inline">y_train</code>: the dependent variable for the analysis.
          <li> <code class = "inline">penalty</code>: the type of regularization applied.  The default value for this parameter is 'none'.
      </ul>
      Fits a logistic regression model to the <code class = "inline">x_train</code> and
      <code class = "inline">y_train</code> data, using the logistic model from <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html">sklearn.linear_model</a>.  The model should use the <code class = "inline">solver = 'saga'</code> to allow all the options for regularization (called <code class = "inline">penalty</code> as the option to the model) be any of <code class = "inline">'elasticnet'</code>, <code class = "inline">'l1'</code>,
      <code class = "inline">'l2'</code>, and <code class = "inline">'none'</code>).  The resulting model should be returned as bytestream, using <a href="https://docs.python.org/3/library/pickle.html">pickle</a>.

    <li> <code class = "inline">predict_using_trained_model(mod_pkl, x, y): -> float,float</code>
      This function takes three inputs:
      <ul>
        <li> <code class = "inline">mod_pkl</code>: a trained model for the data, stored in pickle format.
        <li> <code class = "inline">x</code>: an array or  DataFrame of numeric columns with no null values.
        <li> <code class = "inline">y</code>: an array or DataFrame of numeric columns with no null values.
      </ul>
      Computes and returns the mean squared error and r2 score between the values predicted by the model (<code class = "inline">mod</code> on <code class = "inline">x</code>) and the actual values (<code class = "inline">y</code>).  Note that <code class = "inline">sklearn.metrics</code> contains two functions that may be of use:  <code class = "inline">mean_squared_error</code> and <code class = "inline">r2_score</code>.

</ul>


<br><br>
<p>For example, let's start by setting up a DataFrame, as we did in <a href="p8.html">Program 8</a>, with the file, <a href="taxi_4July2020.csv">taxi_4July2020.csv</a>, add in the tip and time features, and imputing missing values for <code class = "inline">passenger_count</code>:

<pre><code class="blockcode">df = import_data('taxi_4July2020.csv')
df = add_tip_time_features(df)
df['passenger_count'] = impute_numeric_cols(df,['passenger_count'])
</code></pre>

Next, let's use our new functions to add in boroughs for the pick up and drop off locations:
<pre><code class="blockcode">df = answer.add_boro(df,'taxi_zones.csv')
print('\nThe locations and borough columns:')
print(f"{df[['PULocationID','PU_borough','DOLocationID','DO_borough']]}")</code></pre>

<p>which prints out the new columns:
<pre><code class="datablock">The locations and borough columns:
       PULocationID PU_borough  DOLocationID DO_borough
0               100  Manhattan           249  Manhattan
1               235      Bronx           213      Bronx
2               141  Manhattan            82     Queens
3                90  Manhattan            90  Manhattan
4                79  Manhattan           263  Manhattan
...             ...        ...           ...        ...
14412           163  Manhattan           162  Manhattan
14413            74  Manhattan            41  Manhattan
14414           162  Manhattan           238  Manhattan
14415           138     Queens           107  Manhattan
14416            48  Manhattan            74  Manhattan

[14417 rows x 4 columns]</code></pre>

<p>We can add the indicators for if a toll was paid and if the trip started and ended in different boroughs:
<pre><code class="blockcode">df = add_flags(df)
print(df[['trip_distance','PU_borough','DO_borough','paid_toll','cross_boro']])
</code></pre>
prints:
<pre><code class="datablock">       trip_distance PU_borough DO_borough  paid_toll  cross_boro
0               1.70  Manhattan  Manhattan          1           0
1               5.25      Bronx      Bronx          1           0
2               5.50  Manhattan     Queens          1           1
3               0.40  Manhattan  Manhattan          1           0
4               4.50  Manhattan  Manhattan          1           0
...              ...        ...        ...        ...         ...
14412           1.78  Manhattan  Manhattan          1           0
14413           0.92  Manhattan  Manhattan          1           0
14414           4.60  Manhattan  Manhattan          1           0
14415          11.10     Queens  Manhattan          0           1
14416           5.08  Manhattan  Manhattan          1           0

[14417 rows x 5 columns]</code></pre>

<p>
Let's explore the data some, by making scatter plots of some of features:
<pre><code class="blockcode">import matplotlib.pyplot as plt
import seaborn as sns
sns.set_theme(color_codes=True)

sns.lmplot(x="trip_distance", y="duration", data=df)
tot_r = df['trip_distance'].corr(df['duration'])
plt.title(f'Taxi Trips from 4 July 2020 with r = {tot_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()
sns.lmplot(x="trip_distance", y="paid_toll", data=df,fit_reg=False)
dist_r = df['trip_distance'].corr(df['paid_toll'])
plt.title(f'Taxi Trips from 4 July 2020 with r = {dist_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()
sns.lmplot(x="trip_distance", y="cross_boro", data=df,fit_reg=False)
dist_r = df['trip_distance'].corr(df['cross_boro'])
plt.title(f'Taxi Trips from 4 July 2020 with r = {dist_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()</code></pre>


<p>The resulting images:

<p><img src="taxi_dist_v_duration.png" height = 300>
<img src="taxi_dist_v_paid_toll.png" height = 300>
<img src="taxi_dist_v_cross_boro.png" height = 300>


<p>
Interestingly, in our left image, the distance traveled and the duration of the trip are not strongly correlated.  The middle image show negative correlation between trip distance and paying tolls, with outliers influencing the relationship.  While the right images shows the trip distance positively correlated with trips that start and end in different boroughs.

<br><br><i>More details to follow...</i>
<!--
Let's build a logistic model on just these two features:  trip_distance and cross_boro.

<p>
Next, let's encode the categorical columns for pick up and drop off boroughs so we can use them as inputs for our model.

<pre><code class="blockcode"></code></pre>

<p>

<pre><code class="datablock"></code></pre>

<p>We'll split our data into training and testing data sets:

<pre><code class="blockcode"></code></pre>

<p>

<pre><code class="datablock"></code></pre>

<p>Now, we're ready to fit some models to our data.  We'll try first just a single independent variable, trip_distance, and build a logistic model without regularization, to predict when trips start in one borough and end in another:


<pre><code class="blockcode"></code></pre>

<p>

<pre><code class="datablock"></code></pre>


<p>Let's add in different regularization approaches:

<pre><code class="blockcode"></code></pre>

<p>

<pre><code class="datablock"></code></pre>

<p>
  And now try with additional features:
Build logistic model, wo Regularization and with regularization.  Then save models as pkl files to use/compare for later.  Do similar analysis with multiple inputs.

<pre><code class="blockcode"></code></pre>

<p>

<pre><code class="datablock"></code></pre>

<p>
Let's build a more complicated model that uses multiple inputs, including the numerical columns:

<pre><code class="blockcode"></code></pre>

<p>

<pre><code class="datablock"></code></pre>
-->
</div>
</body>
</html>
