<!DOCTYPE doctype PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type"
 content="text/html; charset=iso-8859-1">
  <title>Program 9, CSci 39542: Data Science, Hunter College</title>
</head>
<STYLE>A {text-decoration: none;}
th, td { padding: 5px; }
code {
  background-color: #eeeeee;
}
.inline {
  padding: 1px;
}
.blockcode {
  border: 1px solid #999999;
  display: block;
  padding-left: 10px;
  padding-top : 2px;
  padding-bottom : 2px;
  margin: 5px;
}
.datablock {
  border: 1px solid #eeeeee;
  display: block;
  padding: 7px;
  padding-top : 0px;
  margin: 5px;
}
</STYLE>
<body>


<div style="margin: 15px;width=100%;">
    <span style= "float: left;font-size:larger"><a href="index.html">CSci 39542</a></span>
    <span style= "float: right">
      <a href="syl.html">Syllabus</a>&nbsp;&nbsp;&nbsp;
      <a href="resources.html">Resources</a>&nbsp;&nbsp;&nbsp;
      <a href="work.html">Coursework</a><!--&nbsp;&nbsp;&nbsp;
      <a href="faq.html">FAQ</a>-->
    </span>
</div>

<br>
<br>
<hr>

<div style="margin:50px">


<h2>Program 9:  Logistic Taxi
  <br>CSci 39542: Introduction to Data Science<br>
<a href="http://www.hunter.cuny.edu/csci">Department of Computer Science</a><br>
<a href="https://hunter.cuny.edu">Hunter College</a>, <a href="https://www.cuny.edu">City University of New York</a><br>
Spring 2022<br><br>
</h2>


<hr>
<a href="work.html#cw">Classwork</a>&nbsp;&nbsp;&nbsp;
<a href="work.html#quizzes">Quizzes</a>&nbsp;&nbsp;&nbsp;
<a href="work.html#hw">Homework</a>&nbsp;&nbsp;&nbsp;
<a href="work.html#project">Project</a>&nbsp;&nbsp;&nbsp;
<hr>


<object width=100% height=50% type="text/html" data="generalNotes.html" border="0"
   style="overflow: hidden;">
</object>

<hr>

<h2>Program Description</h2>

<br>
   <p><a name="p9"><b>Program 9: Logistic Taxis.</b></b> &emsp; <i>Due noon, Thursday, 7 April.
     <br>Learning Objective:  to train and validate models, given quantitative and qualitative data, as well as assessing model quality.
     <br>Available Libraries: pandas, datetime, pickle, sklearn, and core Python 3.6+.
     <br>Data Sources: <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> and <a href="https://data.cityofnewyork.us/Transportation/NYC-Taxi-Zones/d3c5-ddgc">NYC Taxi Zones</a> from OpenData NYC.
     <br>Sample Datasets:  <a href="../fall21/taxi_new_years_day_2020.csv">taxi_new_years_day_2020.csv</a>,
      <a href="../fall21/taxi_new_years_day_2020.csv">taxi_4July2020.csv</a>,
      <a href="taxi_jfk_june2020.csv">taxi_jfk_june2020.csv</a>, and
      <a href="taxi_zones.csv">taxi_zones.csv</a>.<br></i>


    <p>
    <a href="https://www1.nyc.gov/site/tlc/businesses/yellow-cab.page"><img src = "https://www1.nyc.gov/assets/tlc/images/content/pages/businesses/yellow-cab.png" height=300 alt="image of yellow taxi"></a>

    <p>
    As in  <a href="p8.html">Program 8</a>, this program is tailored to the NYC OpenData Yellow Taxi Trip Data and follows standard strategy for data cleaning and model building of:
    <ol>
       <li> Read in datasets, merging and cleaning as needed.
       <li> Impute missing values (we will use median for the ordinal values and "most popular" for nominal values).
       <li> Use categorical encoding for qualitative values.
       <li> Split our dataset into training and testing sets.
       <li> Fit a model, or multiple models, to the training dataset.
       <li> Validate the models using the testing dataset.
    </ol>
    To identify which trips are most likely to pay tolls, this program will focus on building a logistic regression model on both the categorical and numerical features of our dataset.

    <p>The function specifications are below:

<p>In your program, include the following functions from <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard:
<ul>
    <li> <code class = "inline">import_data(file_name) -> pd.DataFrame:</code>
      This function takes as one input parameter:
      <ul>
        <li> <code class = "inline">file_name</code>: the name of a CSV file containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC.
      </ul>
      The data in the file is read into a DataFrame, and the resulting DataFrame is returned.  <br>(Note this is identical to the function with the same name in <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard.)

    <li> <code class = "inline">add_tip_time_features(df) -> pd.DataFrame:</code>
      This function takes one input:
      <ul>
        <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC.
      </ul>
      The function computes 3 new columns:
      <ul>
        <li><code class = "inline">percent_tip</code>: which is <code class="inline">100*tip_amount/(total_amount-tip_amount)</code>
        <li><code class = "inline">duration</code>: the time the trip took in seconds.
        <li><code class = "inline">dayofweek</code>: the day of the week that the trip started, represented as 0 for Monday, 1 for Tuesday, ... 6 for Sunday.
      </ul>
      The original DataFrame with these additional three columns is returned.
      <br> (Note this is identical to the function with the same name in <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard.)
      <li> <code class = "inline">impute_numeric_cols(df, x_num_cols) -> pd.DataFrame:</code>
        This function takes two inputs:
        <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing Yellow Taxi Trip Data from OpenData NYC.
          <li> <code class = "inline">x_num_cols</code>: a list of numerical columns in <code class = "inline">df</code>.
        </ul>
        Missing data in the columns <code class = "inline">x_num_cols</code> are replaced with the median of the column.  Returns a DataFrame containing only the imputed numerical columns from input <code class = "inline">df</code>.
    <br>(Note this is identical to the function with the same name in <a href="p8.html">Program 8</a>.  You may use your earlier function or the Program 8 solution available on Blackboard.)
  </ul>

And write the following new functions:

  <ul>
    <li> <code class = "inline">add_boro(df, file_name) -> pd.DataFrame:</code>
      This function takes as two input parameters:
      <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC.
          <li> <code class = "inline">file_name</code>: the name of a CSV file containing <a href="https://data.cityofnewyork.us/Transportation/NYC-Taxi-Zones/d3c5-ddgc">NYC Taxi Zones</a> from OpenData NYC.
      </ul>
      Makes a DataFrame, using <code class = "inline">file_name</code>, to add pick up and drop off boroughs to <code class = "inline">df</code>.
      In particular, adds two new columns to the <code class = "inline">df</code>:
      <ul>
        <li> <code class = "inline">PU_borough</code> that contain the borough corresponding to the pick up taxi zone ID (stored in <code class = "inline">PULocationID</code>), and
        <li> <code class = "inline">DO_borough</code> that contain the borough corresponding to the drop off taxi zone (stored in <code class = "inline">DOLocationID</code>)
      </ul>
      Returns <code class = "inline">df</code> with these two additional columns (<code class = "inline">PU_borough</code> and <code class = "inline">DO_borough</code>).

    <li> <code class = "inline">add_flags(df) -> pd.DataFrame:</code>
      This function takes one input parameter:
      <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC to which <code class = "inline">add_boro()</code> has been applied.
      </ul>
      Adds two new columns:
      <ul>
        <li> <code class = "inline">paid_toll</code> which is 1 if a toll was paid on the trip and 0 in no tolls were paid.
        <li> <code class = "inline">cross_boro</code> which is 1 if the trip started and ended in different borough, and 0 if the trip started and ended in the same borough.
      </ul>
      Returns <code class = "inline">df</code> with these two additional columns (<code class = "inline">paid_toll</code> and <code class = "inline">cross_boro</code>)

    <li> <code class = "inline">encode_categorical_cols(df) -> pd.DataFrame:</code>
      This function takes one input parameter:
      <ul>
          <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC to which <code class = "inline">add_boro()</code> has been applied.
      </ul>
      Apply to the borough columns...  <code class = "inline">PU_borough</code> and <code class = "inline">DO_borough</code> Check for naming convention of get_dummies

      One hot encode categorical columns, remove first variable, to get k-1 dummies out of k categorical levels
      :param df_cat_imputed: pandas dataframe, output of impute_categorical_cols()
      :return: pandas dataframe containing the one hot encoded categorical dataframe



    <li> <code class = "inline">split_test_train(df, y_col_name, df_cat_encoded, df_num_imputed, df_num_transformed,
                       test_size=0.25, random_state=12345) -> Union[pd.DataFrame, pd.Series()]:</code>
      This function takes ??? input parameter:
       <ul>
           <li> <code class = "inline">df</code>: a DataFrame containing <a href="https://data.cityofnewyork.us/Transportation/2020-For-Hire-Vehicles-Trip-Data/m3yx-mvk4">Yellow Taxi Trip Data</a> from OpenData NYC to which <code class = "inline">add_boro()</code> has been applied.
           <li>  <code class = "inline">y_col_name</code>:
           <li>  <code class = "inline">df_cat_encoded</code>:
           <li>  <code class = "inline">df_num_imputed</code>:
           <li>  <code class = "inline">df_num_transformed</code>:
           <li>  <code class = "inline">test_size</code>:
           <li>  <code class = "inline">random_state</code>:
      </ul>


    <li> <code class = "inline">fit_logistic_regression(x_train, y_train,regularization='none'):</code>
      This function takes three input parameter:
      <ul>
          <li> <code class = "inline">x_train</code>: .
          <li> <code class = "inline">y_train</code>: .
          <li> <code class = "inline">regularization</code>: .
      </ul>
      Fits a logistic regression model to the <code class = "inline">x_train</code> and
      <code class = "inline">y_train</code> data, using the logistic model from <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegression.html">sklearn.linear_model</a>.  The model should use the <code class = "inline">solver = 'saga'</code> to allow all the options for regularization (called <code class = "inline">penalty</code> as the option to the model) be any of <code class = "inline">'elasticnet'</code>, <code class = "inline">'l1'</code>, <code class = "inline">'l2'</code>, and <code class = "inline">'none'</code>).  The resulting model should be returned as bytestream, using <a href="https://docs.python.org/3/library/pickle.html">pickle</a>.

    <li> <code class = "inline">predict_using_trained_model(mod_pkl, x, y):</code>
      This function takes three inputs:
      <ul>
        <li> <code class = "inline">mod_pkl</code>: a trained model for the data, stored in pickle format.
        <li> <code class = "inline">x</code>: an array or  DataFrame of numeric columns with no null values.
        <li> <code class = "inline">y</code>: an array or DataFrame of numeric columns with no null values.
      </ul>
      Computes and returns the mean squared error and r2 score between the values predicted by the model (<code class = "inline">mod</code> on <code class = "inline">x</code>) and the actual values (<code class = "inline">y</code>).  Note that <code class = "inline">sklearn.metrics</code> contains two functions that may be of use:  <code class = "inline">mean_squared_error</code> and <code class = "inline">r2_score</code>.

</ul>


<br><br>
<p>For example, let's start by setting up a DataFrame, as we did in <a href="p8.html">Program 8</a>, with the file, <a href="taxi_jfk_june2020.csv">taxi_jfk_june2020.csv</a>, add in the tip and time features, and imputing missing values for <code class = "inline">passenger_count</code>:

<pre><code class="blockcode">df = import_data('taxi_jfk_june2020.csv')
df = add_tip_time_features(df)
df['passenger_count'] = impute_numeric_cols(df,['passenger_count'])
</code></pre>

Next, let's use our new functions to add in boroughs for the pick up and drop off locations, as well as the indicators for if a toll was paid and if the trip started and ended in different boroughs:
<pre><code class="blockcode">df = df.add_flags(df)
SHOULD we split encode_categorical_cols-- split into pieces?
</code></pre>
prints:
<pre><code class="datablock"></code></pre>

<p>
Make plots duration vs. distance and cross_boro vs. paid_toll
<pre><code class="blockcode">#Explore some data:
import matplotlib.pyplot as plt
import seaborn as sns
sns.set_theme(color_codes=True)

sns.lmplot(x="total_amount", y="percent_tip", data=df)
tot_r = df['total_amount'].corr(df['percent_tip'])
plt.title(f'Taxi Trips from JFK, June 2020 with r = {tot_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()
sns.lmplot(x="trip_distance", y="percent_tip", data=df)
dist_r = df['trip_distance'].corr(df['percent_tip'])
plt.title(f'Taxi Trips from JFK, June 2020 with r = {dist_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()</code></pre>


<p>The resulting images:

<p><img src="p8_jfk_total_tip.png" height = 300>
<img src="p8_jfk_dist_tip.png" height = 300>


<p>
Make a scatter plot of distace versus paid_toll:

<pre><code class="blockcode">#Explore some data:
import matplotlib.pyplot as plt
import seaborn as sns
sns.set_theme(color_codes=True)

sns.lmplot(x="total_amount", y="percent_tip", data=df)
tot_r = df['total_amount'].corr(df['percent_tip'])
plt.title(f'Taxi Trips from JFK, June 2020 with r = {tot_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()
sns.lmplot(x="trip_distance", y="percent_tip", data=df)
dist_r = df['trip_distance'].corr(df['percent_tip'])
plt.title(f'Taxi Trips from JFK, June 2020 with r = {dist_r:.2f}')
plt.tight_layout()  #for nicer margins
plt.show()</code></pre>

<p>The resulting images:

<p><img src="p8_jfk_total_tip.png" height = 300>
<img src="p8_jfk_dist_tip.png" height = 300>



<p>
Can we predict when someone pays a toll.  Note that paying a toll suggests crossing borough but not necessarily the reverse:

<p>
Build logistic model, wo Regularization and with regularization.  Then save models as pkl files to use/compare for later.  Do similar analysis with multiple inputs.








<p>
Let's build a more complicated model that uses multiple inputs, including the numerical columns:

<pre><code class="blockcode"></code></pre>

<p> With the missing numeric data imputed, we can fit the model on training sets (of size 25%):

<pre><code class="blockcode"></code></pre>

<p>the resulting model does a reasonable both with the training and testing data sets that we used to validate the model:

<pre><code class="datablock">
</code></pre>

<p>We can use the model for other yellow taxi data sets to see how well our model does:

<pre><code class="blockcode"></code></pre>

<p>The root mean squared error is higher, but still a reasonable fit:
<pre><code class="datablock">
</code></pre>

<p>Do we need 25% of the data for training?  Let's try with just 10% of the data and see how well the model does on the training and testing data:

<pre><code class="blockcode"></code></pre>

<pre><code class="datablock">
</code></pre>

<p>Lastly, we can use quadratic features to build a model:

<pre><code class="blockcode">
</pre></code>

<p>the resulting model produces the following parameters and does very well with the training data, but not as well on validation:

<pre><code class="datablock">
</code></pre>


</div>
</body>
</html>
